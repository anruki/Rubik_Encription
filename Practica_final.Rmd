---
title: "Untitled"
author: "Jaime Martinez Torio"
date: "2024-04-12"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(readxl)
library(inspectdf)
library(forecast)
library(ggplot2)

```

En primer lugar, cargamos la serie temporal relacionada con la venta de coches. La bbdd selecionada contiene la siguiente estructura:
  -Month: Fecha del mes (por ejemplo, 2016-01, 2016-02, etc.)
  -Sales: Número de ventas realizadas en ese mes.
```{r}
datos <- read.csv('sales-cars.csv', sep=',') 
head(datos)
```
Veamos de que tipo es cada variable:
```{r}
show_plot(inspect_types(datos))
```

Mostramos los valores que toma la serie a lo largo del tiempo:
```{r}
autoplot(serie)
```
A primera vista parece una serie ascendente con posible estacionalidad, al tener una caída de las ventas a finales de cada año (el año 2018 no está completo por lo que no se puede deducir su comportamiento)

# Estudio de la estacionariedad y componentes de la serie
Preparamos la base de datos y creamos una serie temporal a partir de ella.
```{r}
# Convertimos la columna 'Month' a formato de fecha
datos$Month <- as.Date(as.character(datos$Month), format="%Y-%m")

# Creamos la serie temporal desde la columna 'Sales'
serie <- ts(datos$Sales, start = c(2016, 1), end = c(2018,11), frequency = 12) # reservamos el último mes para predicciones

# Descomponemos la serie temporal de forma multiplicativa
comp <- decompose(serie, type = "multiplicative")

```

Gráfica de la descomposición de la serie temporal:
```{r}
autoplot(comp)
```
  -**Datos originales** (data): los datos observados capturan la combinación de la tendencia, estacionalidad y otros factores que vamos a estudiar a continuación.
  
  -**Tendencia** (trend): la serie temporal muestra una **tendencia creciente** a lo largo del tiempo, lo que indica que las ventas han estado aumentando. Además el crecimiento parece constante desde mediados de 2016 hasta mediados de 2018.
  
  -**Estacionalidad** (seasonal): hay fluctuaciones periódicas en los datos, es decir, las ventas son afectadas por factores estacionales. Estas fluctuaciones podrían deberse a factores externos, como campañas de marketing, temporadas de vacaciones, o incluso cambios económicos estacionales que afectan al comportamiento del consumidor. Observamos que hay un patrón que se repite: a finales de cada año se produce un aumento de las ventas, seguido de un fuerte descenso. Este comportamiento podría estar relacionado a que al finalizar las vacaciones de verano, las personas compran coches para poder desplazarse al trabajo. Seguidamente, hay un descenso de ventas durante el inicio del nuevo año, tal vez debido a la mayor inseguridad de la carretera por lluvias y nieve.

Como la serie tiene tendencia y estacionalidad, no es estacionaria.
  
  -**Residuos** (remainder): Los residuos son las variaciones en los datos después de retirar la tendencia y la estacionalidad. Estos podrían ser debidos a factores irregulares o aleatorios no capturados por los modelos de tendencia y estacionalidad. En la gráfica, los residuos parecen ser bastante estables y no muestran patrones claros, lo que es una buena señal de que la descomposición ha capturado adecuadamente la mayor parte de la información en los datos originales.
  
Para estudiar el comportamiento de la serie de forma analítica, comprobamos los coeficientes estacionales.

```{r}
# Crear un marco de datos con los meses y los coeficientes
meses <- c("Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre")
coeficientes <- comp$figure
tabla_coeficientes <- data.frame(Mes = meses, Coeficiente = coeficientes)

# Mostrar la tabla sin truncar
print(tabla_coeficientes, n = 12)
```
```{r}
comp$figure
```

Valores cercanos a 1, como 0.9815194 y 0.9795536, sugieren que las ventas en esos meses están muy cerca del promedio anual.Los valores por encima de 1, como 1.1179146, 1.1208343, y 1.2186852, indican que en abril, agosto y diciembre las ventas son superiores al promedio anual. El valor más alto (1.2186852) se da en diciembre y muestra un aumento de aproximadamente un 22% por encima de la media, posiblemente relacionado con la Navidad.


En conclusion, de los datos se obtiene un patrón estacional con meses específicos con ventas por encima o por debajo de la media. Sin embargo, las variaciones parecen ser menos extremas en comparación con la base de datos de referencia. Esto podría deberse a diferencias en los productos, los comportamientos de compra de los clientes, o incluso factores geograficos o economicos que afectan a las ventas de diferentes maneras.

Para comparar las ventas de cada mes en distintos años, utilizamos la siguiente gráfica:
```{r}
ggseasonplot(serie, year.labels=TRUE, year.labels.left=TRUE) 
```
De nuevo observamos patrones estacionales, aunque no hay el mismo número de ventas en cada mes de cada año, sí que se sigue un






```{r}
#Calculamos las autocorrelaciones simples
ggAcf(serie, lag=36)
```

```{r}
#Calculamos las autocorrelaciones parciales
ggPacf(serie, lag=36)
```

```{r}
autoplot(diff(serie))
```

```{r}
autoplot(diff(diff(serie),12))
```

```{r}
#Guardo la serie diferenciada
serie <- diff(diff(serie),12)
#Calculamos las autocorrelaciones simples
ggAcf(serie, lag=36)
```

```{r}
#Calculamos las autocorrelaciones parciales
ggPacf(serie, lag=36)
```
# Alisado de la serie. Método de Holt-Winters.
Este modelo se utiliza para series estacionales, independientemente de si tienen tendencia identificada o no.

```{r}
# Suponiendo que 'serie' es tu serie temporal y 'tiempo' es un vector de tiempo
# Se ajusta un modelo Holt-Winters a la serie temporal
modelo_hw <- hw(serie, seasonal="multiplicative", h=12)
summary(modelo_hw)
```

# Predicción con modelo de alisado
A continuación, retomando la serie que estamos estudiando, referente a las ventas
registradas entre los años 2016 y finales 2019, vamos a predecir las ventas en los dos primeros
meses del año 2019.
Para poder comprobar los resultados de nuestras predicciones, hemos reservado estos dos valores, que sí
conocemos, en la base de datos. Voy a recuperarlos y guardarlos en una tabla donde iremos añadiendo
diferentes resultados

```{r}
res <- datos[c(2018,12)]
res

```


```{r}
pred <- holt(serie, # Serie que utilizamos para predecir
h = 2) # Observaciones que queremos predecir
summary(pred)
```
Vamos a representar estas predicciones.

```{r}
autoplot(pred)
```




